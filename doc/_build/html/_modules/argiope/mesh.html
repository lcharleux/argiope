

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>argiope.mesh &mdash; Argiope: Python FEM data manager  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Argiope: Python FEM data manager  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Argiope: Python FEM data manager
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks-rst/notebooks_index.html">Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mesh.html">Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mesh.html#fields">Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mesh.html#parsers">Parsers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Argiope: Python FEM data manager</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>argiope.mesh</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for argiope.mesh</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">argiope</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="k">import</span> <span class="n">Template</span>

<span class="n">MODPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">argiope</span><span class="p">))</span>

<span class="c1">################################################################################</span>
<span class="c1"># CONSTANTS AND DEFINITIONS</span>
<span class="c1">################################################################################</span>
<span class="k">class</span> <span class="nc">Element</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  The Element meta class.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nvert</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">simplices</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nvert</span> <span class="o">=</span> <span class="n">nvert</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">simplices</span> <span class="o">=</span> <span class="n">simplices</span>
    
  
  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{0}</span><span class="s2">D element w. </span><span class="si">{1}</span><span class="s2"> vert.&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvert</span><span class="p">)</span>
  
  <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;labels&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits elements of the rigth type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span>

<span class="k">class</span> <span class="nc">Element0D</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
  <span class="n">space</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Element1D</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
  <span class="n">space</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">pass</span>
  
<span class="k">class</span> <span class="nc">Element2D</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
  <span class="n">space</span> <span class="o">=</span> <span class="mi">2</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">optimal_angles</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">angles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimal_angles</span> <span class="o">=</span> <span class="n">optimal_angles</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  
  <span class="k">def</span> <span class="nf">get_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
  <span class="n">surfaces</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_surfaces</span><span class="p">)</span>  
    
<span class="k">class</span> <span class="nc">Element3D</span><span class="p">(</span><span class="n">Element</span><span class="p">):</span>
  <span class="n">space</span> <span class="o">=</span> <span class="mi">3</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="n">faces_types</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">faces</span> <span class="o">=</span> <span class="n">faces</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">faces_types</span> <span class="o">=</span> <span class="n">faces_types</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ELEMENTS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">faces_types</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">angles</span><span class="p">]</span> 
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">faces</span><span class="p">))])</span>
  <span class="n">angles</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_angles</span><span class="p">)</span>  
  
  <span class="k">def</span> <span class="nf">get_surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">faces</span>
  <span class="n">surfaces</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_surfaces</span><span class="p">)</span>
  
   
<span class="n">ELEMENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;point1&quot;</span><span class="p">:</span> <span class="n">Element0D</span><span class="p">(</span><span class="n">nvert</span> <span class="o">=</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;line2&quot;</span><span class="p">:</span> <span class="n">Element1D</span><span class="p">(</span>
        <span class="n">nvert</span> <span class="o">=</span>  <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;tri3&quot;</span><span class="p">:</span>  <span class="n">Element2D</span><span class="p">(</span>
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>                   
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]),</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">optimal_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">60.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">])),</span>               
    <span class="s2">&quot;quad4&quot;</span><span class="p">:</span> <span class="n">Element2D</span><span class="p">(</span>
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]),</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">optimal_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">])),</span> 
    <span class="s2">&quot;tetra4&quot;</span><span class="p">:</span> <span class="n">Element3D</span><span class="p">(</span>
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>                   
        <span class="n">faces_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;tri3&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;tri3&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;tri3&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;tri3&quot;</span><span class="p">]),</span>
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])),</span>
    <span class="s2">&quot;pyra5&quot;</span><span class="p">:</span> <span class="n">Element3D</span><span class="p">(</span>
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]),</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">])],</span>          
        <span class="n">faces_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;quad4&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;tri3&quot;</span><span class="p">,</span> <span class="s2">&quot;tri3&quot;</span><span class="p">,</span> <span class="s2">&quot;tri3&quot;</span><span class="p">,</span> <span class="s2">&quot;tri3&quot;</span><span class="p">]),</span>
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])),</span> 
    <span class="s2">&quot;prism6&quot;</span><span class="p">:</span> <span class="n">Element3D</span><span class="p">(</span> 
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]),</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span> 
                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])],</span>
        <span class="n">faces_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;tri3&quot;</span><span class="p">,</span> <span class="s2">&quot;tri3&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">]),</span>                      
        <span class="n">simplices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                              <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]])),</span>
    <span class="s2">&quot;hexa8&quot;</span><span class="p">:</span><span class="n">Element3D</span><span class="p">(</span>  
        <span class="n">nvert</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]]),</span>
        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> 
                          <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
        <span class="n">faces_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> 
                                <span class="s2">&quot;quad4&quot;</span><span class="p">,</span> <span class="s2">&quot;quad4&quot;</span><span class="p">]),</span>                      
        <span class="n">simplices</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  
                            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])),</span>
                                        
       <span class="p">}</span>    
    
     
<span class="c1">################################################################################</span>
                  

<span class="c1">################################################################################</span>
<span class="c1"># MESH CLASSES </span>
<span class="c1">################################################################################</span>
  
<div class="viewcode-block" id="Mesh"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh">[docs]</a><span class="k">class</span> <span class="nc">Mesh</span><span class="p">(</span><span class="n">argiope</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Container</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A single class to handle meshes. </span>
<span class="sd">  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Mesh.__init__"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The constructor only a redirection to the following methods:</span>
<span class="sd">    </span>
<span class="sd">    * set_nodes</span>
<span class="sd">    * set_elements</span>
<span class="sd">    * set_fields</span>
<span class="sd">    </span>
<span class="sd">    .. literalinclude:: examples/mesh/Mesh.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_nodes</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_elements</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_fields</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
  
  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">Ne</span><span class="p">,</span> <span class="n">Nn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">Ne</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">Nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;Mesh, </span><span class="si">{0}</span><span class="s2"> nodes, </span><span class="si">{1}</span><span class="s2"> elements, </span><span class="si">{2}</span><span class="s2"> fields&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
           <span class="n">Nn</span><span class="p">,</span> <span class="n">Ne</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>
  
<div class="viewcode-block" id="Mesh.set_nodes"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.set_nodes">[docs]</a>  <span class="k">def</span> <span class="nf">set_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlabels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nsets</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the node data.</span>
<span class="sd">    </span>
<span class="sd">    .. literalinclude:: examples/mesh/Mesh-set_nodes.py</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">if</span> <span class="n">nlabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="k">else</span><span class="p">:</span>
      <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(((</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> 
                                           <span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span> 
                                           <span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">)))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">coords</span><span class="p">,</span> 
                                <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">nlabels</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>
        
<div class="viewcode-block" id="Mesh.set_elements"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.set_elements">[docs]</a>  <span class="k">def</span> <span class="nf">set_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elabels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                         <span class="n">types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                         <span class="n">stypes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> 
                         <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                         <span class="n">esets</span> <span class="o">=</span> <span class="p">{},</span> 
                         <span class="n">surfaces</span> <span class="o">=</span> <span class="p">{},</span> 
                         <span class="n">materials</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the element data.</span>
<span class="sd">    </span>
<span class="sd">    . literalinclude:: examples/mesh/Mesh-set_elements.py</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># COLUMNS BUILDING</span>
    <span class="k">if</span> <span class="n">elabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>   
      <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">types</span><span class="p">,</span>
                                   <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
                                   <span class="n">index</span> <span class="o">=</span> <span class="n">elabels</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;element&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;solver&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">stypes</span>
      <span class="c1"># Connectivity </span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">elabels</span><span class="p">)</span>
      <span class="n">c</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
      <span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">c</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s2">&quot;conn&quot;</span><span class="p">],</span> 
                                              <span class="p">[</span><span class="s2">&quot;n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> 
                                               <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span> 
                                              <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="c1"># Sets</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">esets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">fk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;surfaces&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;s</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fk</span><span class="p">))]</span> <span class="o">=</span> <span class="n">vv</span>
      <span class="c1"># Materials</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;materials&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">materials</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span></div>
       
<div class="viewcode-block" id="Mesh.set_fields"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.set_fields">[docs]</a>  <span class="k">def</span> <span class="nf">set_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">fields</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></div>
      
<div class="viewcode-block" id="Mesh.check_elements"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.check_elements">[docs]</a>  <span class="k">def</span> <span class="nf">check_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks element definitions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ELEMENT TYPE CHECKING</span>
    <span class="n">existing_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">argiope</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">allowed_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ELEMENTS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">existing_types</span> <span class="o">&lt;=</span> <span class="n">allowed_types</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Element types </span><span class="si">{0}</span><span class="s2"> not in know elements </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="n">existing_types</span> <span class="o">-</span> <span class="n">allowed_types</span><span class="p">,</span> <span class="n">allowed_types</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;Elements: OK&gt;&quot;</span><span class="p">)</span>                   </div>
    
  
  <span class="k">def</span> <span class="nf">space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the dimension of the embedded space of each element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">argiope</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
           <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">ELEMENTS</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">space</span><span class="p">)</span>  
  
<div class="viewcode-block" id="Mesh.nvert"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.nvert">[docs]</a>  <span class="k">def</span> <span class="nf">nvert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the number of vertices of eache element according to its type/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">argiope</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
           <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">ELEMENTS</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">nvert</span><span class="p">)</span>   </div>
  
  <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">into</span> <span class="o">=</span> <span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
            <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">sort_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the decomposition of the elements.</span>
<span class="sd">    </span>
<span class="sd">    Inputs:</span>
<span class="sd">    * into: must be in [&#39;edges&#39;, &#39;faces&#39;, &#39;simplices&#39;, &#39;angles&#39;]</span>
<span class="sd">    * loc: None or labels of the chosen elements.</span>
<span class="sd">    * at: must be in [&#39;labels&#39;, &#39;coords&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
      <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
    <span class="k">else</span><span class="p">:</span>  
      <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">groupby</span><span class="p">([(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">output_maps</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ELEMENTS</span><span class="p">[</span><span class="n">etype</span><span class="p">],</span> <span class="n">into</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">om</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_maps</span><span class="p">)):</span>
          <span class="n">oshape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_maps</span><span class="p">[</span><span class="n">om</span><span class="p">])</span>
          <span class="n">conn</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">conn</span>
          <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([(</span><span class="n">om</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">oshape</span><span class="p">)],</span> 
                                                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">into</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">])</span>
          <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">output_maps</span><span class="p">[</span><span class="n">om</span><span class="p">]]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">),</span> <span class="n">oshape</span><span class="p">))</span>
          <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> 
                            <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">,</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
          <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not extract &#39;</span><span class="si">{0}</span><span class="s2">&#39; from &#39;</span><span class="si">{1}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">into</span><span class="p">,</span> <span class="n">etype</span><span class="p">))</span>                           
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
      <span class="n">out</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">at</span> <span class="o">==</span> <span class="s2">&quot;coords&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> 
                           <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">out</span> 

<div class="viewcode-block" id="Mesh.centroids_and_volumes"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.centroids_and_volumes">[docs]</a>  <span class="k">def</span> <span class="nf">centroids_and_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dataframe containing volume and centroids of all the elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">groupby</span><span class="p">([(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]):</span>
      <span class="n">etype_info</span> <span class="o">=</span> <span class="n">ELEMENTS</span><span class="p">[</span><span class="n">etype</span><span class="p">]</span>
      <span class="n">simplices_info</span> <span class="o">=</span> <span class="n">etype_info</span><span class="o">.</span><span class="n">simplices</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">index</span>
      <span class="n">simplices_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">into</span> <span class="o">=</span> <span class="s2">&quot;simplices&quot;</span><span class="p">,</span> 
                             <span class="n">loc</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span>
                             <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;coords&quot;</span><span class="p">)</span> 
      <span class="n">simplices</span> <span class="o">=</span> <span class="n">simplices_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                  <span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                  <span class="n">simplices_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                  <span class="n">simplices_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                  <span class="mi">3</span><span class="p">)</span> 
      <span class="n">edges</span> <span class="o">=</span> <span class="n">simplices</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">simplices</span><span class="p">[:,:,:</span><span class="mi">1</span><span class="p">]</span> 
      <span class="n">simplices_centroids</span> <span class="o">=</span> <span class="n">simplices</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">etype_info</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">simplices_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">edges</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> 
                           <span class="n">edges</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> 
                           <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">etype_info</span><span class="o">.</span><span class="n">space</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>          
        <span class="n">simplices_volumes</span> <span class="o">=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">edges</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> 
                                       <span class="n">edges</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> 
                             <span class="o">*</span> <span class="n">edges</span><span class="p">[:,:,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">elements_volumes</span> <span class="o">=</span> <span class="n">simplices_volumes</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">elements_centroids</span> <span class="o">=</span> <span class="p">((</span><span class="n">simplices_volumes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">simplices_volumes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
                          <span class="o">*</span> <span class="n">simplices_centroids</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> 
                          <span class="o">/</span> <span class="n">elements_volumes</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">elements_volumes</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
      <span class="n">volumes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">elements_volumes</span><span class="p">,</span>
                                <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
                                <span class="p">[[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]]))</span>
      <span class="n">centroids_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">elements_centroids</span><span class="p">,</span>
                                <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
                                <span class="p">[[</span><span class="s2">&quot;centroid&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]))</span>                          
      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">volumes_df</span><span class="p">,</span> <span class="n">centroids_df</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>             
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  
    <span class="k">if</span> <span class="n">sort_index</span><span class="p">:</span> <span class="n">out</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span> <span class="mi">1</span><span class="p">)</span></div>
         
<div class="viewcode-block" id="Mesh.angles"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.angles">[docs]</a>  <span class="k">def</span> <span class="nf">angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the internal angles of all elements and the associated statistics </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">etypes</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">etype</span> <span class="ow">in</span> <span class="n">etypes</span><span class="p">:</span>
      <span class="n">etype_info</span> <span class="o">=</span> <span class="n">ELEMENTS</span><span class="p">[</span><span class="n">etype</span><span class="p">]</span>
      <span class="n">angles_info</span> <span class="o">=</span> <span class="n">etype_info</span><span class="o">.</span><span class="n">angles</span>
      <span class="n">loc</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">etype</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
      <span class="n">angles_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">into</span> <span class="o">=</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> 
                             <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">,</span>
                             <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;coords&quot;</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">angles_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                                        <span class="n">angles_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="n">angles_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="mi">3</span><span class="p">)</span>        
      <span class="n">edges</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],:]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,:]</span>
      <span class="n">edges</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
               <span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">angles_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">((</span>
               <span class="n">edges</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">edges</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)))</span>

      <span class="n">deviation</span> <span class="o">=</span> <span class="n">angles</span> <span class="o">-</span> <span class="n">etype_info</span><span class="o">.</span><span class="n">optimal_angles</span>
      <span class="n">angles_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> 
                               <span class="n">data</span> <span class="o">=</span> <span class="n">angles</span><span class="p">,</span> 
                               <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
      <span class="p">[[</span><span class="s2">&quot;angles&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;a</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">angles_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]))</span>
      <span class="n">deviation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> 
                               <span class="n">data</span> <span class="o">=</span> <span class="n">deviation</span><span class="p">,</span> 
                               <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
      <span class="p">[[</span><span class="s2">&quot;deviation&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;d</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">angles_info</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]]))</span>
      
      <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">angles_df</span><span class="p">,</span> <span class="n">deviation_df</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;max_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;min_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;max_angular_deviation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">deviation</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;min_angular_deviation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">deviation</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;max_abs_angular_deviation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">deviation</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>    
      <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>  
      <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
      
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>
  
<div class="viewcode-block" id="Mesh.edges"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.edges">[docs]</a>  <span class="k">def</span> <span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the aspect ratio of all elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="n">at</span> <span class="o">=</span> <span class="s2">&quot;coords&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;lx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;ly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;lz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">edges</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;l&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">edges</span><span class="p">[[</span><span class="s2">&quot;lx&quot;</span><span class="p">,</span> <span class="s2">&quot;ly&quot;</span><span class="p">,</span> <span class="s2">&quot;lz&quot;</span><span class="p">]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="n">edges</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([[</span><span class="s2">&quot;length&quot;</span><span class="p">],</span> 
                    <span class="p">[</span><span class="s2">&quot;e</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]])</span>
    <span class="n">edges</span><span class="p">[(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;lmax&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;lmin&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">edges</span><span class="p">[(</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span> <span class="s2">&quot;aspect_ratio&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lmax</span> <span class="o">/</span> <span class="n">edges</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lmin</span>
    <span class="k">return</span> <span class="n">edges</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span></div>
  
<div class="viewcode-block" id="Mesh.stats"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.stats">[docs]</a>  <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns mesh quality and geometric stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroids_and_volumes</span><span class="p">()</span>
    <span class="n">angles</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">()</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cv</span> <span class="p">,</span> <span class="n">angles</span><span class="p">[[</span><span class="s2">&quot;stats&quot;</span><span class="p">]],</span> <span class="n">edges</span><span class="p">[[</span><span class="s2">&quot;stats&quot;</span><span class="p">]]</span> <span class="p">],</span> 
                     <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Mesh.element_set_to_node_set"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.element_set_to_node_set">[docs]</a>  <span class="k">def</span> <span class="nf">element_set_to_node_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a node set from an element set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]]</span>
           <span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="n">loc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">nodes</span><span class="p">[(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">loc</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Mesh.node_set_to_surface"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.node_set_to_surface">[docs]</a>  <span class="k">def</span> <span class="nf">node_set_to_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a node set to surface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a dummy node with label 0</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dummy</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dummy</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">dummy</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy</span>
    <span class="c1"># Getting element surfaces</span>
    <span class="n">element_surfaces</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;surfaces&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="c1"># killer hack !</span>
    <span class="n">surf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
             <span class="n">nodes</span><span class="o">.</span><span class="n">sets</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">element_surfaces</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
                   <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">element_surfaces</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
             <span class="n">index</span> <span class="o">=</span> <span class="n">element_surfaces</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">surf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s2">&quot;f</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">surf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">k</span><span class="p">]</span></div>
    
    
<div class="viewcode-block" id="Mesh.surface_to_element_sets"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.surface_to_element_sets">[docs]</a>  <span class="k">def</span> <span class="nf">surface_to_element_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates elements sets corresponding to a surface.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">findex</span> <span class="ow">in</span> <span class="n">surface</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="k">if</span> <span class="n">surface</span><span class="p">[</span><span class="n">findex</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="s2">&quot;_SURF_</span><span class="si">{0}</span><span class="s2">_FACE</span><span class="si">{1}</span><span class="s2">&quot;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">findex</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">surface</span><span class="p">[</span><span class="n">findex</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="Mesh.to_polycollection"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.to_polycollection">[docs]</a>  <span class="k">def</span> <span class="nf">to_polycollection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the mesh as matplotlib polygon collection. (tested only for 2D meshes)</span>
<span class="sd">    &quot;&quot;&quot;</span>                          
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">collections</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">groupby</span><span class="p">([(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;argiope&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]):</span>
      <span class="n">index</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
      <span class="n">nvert</span> <span class="o">=</span> <span class="n">ELEMENTS</span><span class="p">[</span><span class="n">etype</span><span class="p">]</span><span class="o">.</span><span class="n">nvert</span>
      <span class="n">conn</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:</span><span class="n">nvert</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
      <span class="n">coords</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">coords</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">),</span> <span class="n">nvert</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">verts</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">verts</span><span class="o">=</span> <span class="n">verts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">collections</span><span class="o">.</span><span class="n">PolyCollection</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span></div>
    
<div class="viewcode-block" id="Mesh.to_triangulation"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.to_triangulation">[docs]</a>  <span class="k">def</span> <span class="nf">to_triangulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the mesh as a matplotlib.tri.Triangulation instance. (2D only)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="k">import</span> <span class="n">Triangulation</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;simplices&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">node_map</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">node_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">conn</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">conn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span></div>
  
<div class="viewcode-block" id="Mesh.write_inp"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.write_inp">[docs]</a>  <span class="k">def</span> <span class="nf">write_inp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports the mesh to the Abaqus INP format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">write_inp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Mesh.fields_metadata"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Mesh.fields_metadata">[docs]</a>  <span class="k">def</span> <span class="nf">fields_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns fields metadata as a dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>  
    <span class="k">return</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;step_num&quot;</span><span class="p">,</span> <span class="s2">&quot;frame&quot;</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">]))</span></div></div>
    
  
<span class="c1">################################################################################</span>
<span class="c1"># FIELDS</span>
<span class="c1">################################################################################  </span>
      
<div class="viewcode-block" id="MetaField"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.MetaField">[docs]</a><span class="k">class</span> <span class="nc">MetaField</span><span class="p">(</span><span class="n">argiope</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Container</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A field mother class.</span>
<span class="sd">  </span>
<span class="sd">  :param label: field label</span>
<span class="sd">  :type label: str</span>
<span class="sd">  :param position: physical position</span>
<span class="sd">  :type position: in [&quot;node&quot;, &quot;element&quot;]</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="n">_positions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
  
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span><span class="p">,</span> 
               <span class="n">step_num</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step_label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">part</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">frame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frame_value</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
               <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">step_num</span> <span class="o">=</span> <span class="n">step_num</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span> <span class="o">=</span> <span class="n">step_label</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">part</span> <span class="o">=</span> <span class="n">part</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">frame_value</span> <span class="o">=</span> <span class="n">frame_value</span>   
          
     <span class="c1"># Data</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span>  <span class="n">data</span>
     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_columns&quot;</span><span class="p">):</span> 
       <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">position</span>
  
  <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> at </span><span class="si">{2}</span><span class="s2">; step=</span><span class="si">{3}</span><span class="s2"> (&#39;</span><span class="si">{4}</span><span class="s2">&#39;); frame=</span><span class="si">{5}</span><span class="s2"> &gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
  
<div class="viewcode-block" id="MetaField.metadata"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.MetaField.metadata">[docs]</a>  <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns metadata as a dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
           <span class="s2">&quot;part&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">part</span><span class="p">,</span>
           <span class="s2">&quot;step_num&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_num</span><span class="p">,</span>
           <span class="s2">&quot;step_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_label</span><span class="p">,</span>
           <span class="s2">&quot;frame&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
           <span class="s2">&quot;frame_value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_value</span><span class="p">,</span>
           <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
           <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>                    
    <span class="p">})</span></div></div>

<div class="viewcode-block" id="Field"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Field">[docs]</a><span class="k">class</span> <span class="nc">Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="k">pass</span>     </div>

<div class="viewcode-block" id="Tensor6Field"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Tensor6Field">[docs]</a><span class="k">class</span> <span class="nc">Tensor6Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Second order symmetric tensor field.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v11&quot;</span><span class="p">,</span> <span class="s2">&quot;v22&quot;</span><span class="p">,</span> <span class="s2">&quot;v33&quot;</span><span class="p">,</span> <span class="s2">&quot;v12&quot;</span><span class="p">,</span> <span class="s2">&quot;v13&quot;</span><span class="p">,</span> <span class="s2">&quot;v23&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Tensor4Field"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Tensor4Field">[docs]</a><span class="k">class</span> <span class="nc">Tensor4Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Second order symmetric 2D tensor field.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v11&quot;</span><span class="p">,</span> <span class="s2">&quot;v22&quot;</span><span class="p">,</span> <span class="s2">&quot;v33&quot;</span><span class="p">,</span> <span class="s2">&quot;v12&quot;</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">Tensor3Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Second order diagonal tensor field.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v11&quot;</span><span class="p">,</span> <span class="s2">&quot;v22&quot;</span><span class="p">,</span> <span class="s2">&quot;v12&quot;</span><span class="p">]</span>
   
<div class="viewcode-block" id="Vector3Field"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Vector3Field">[docs]</a><span class="k">class</span> <span class="nc">Vector3Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  3D vector field.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="s2">&quot;v2&quot;</span><span class="p">,</span> <span class="s2">&quot;v3&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Vector2Field"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.Vector2Field">[docs]</a><span class="k">class</span> <span class="nc">Vector2Field</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  2D vector field.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="s2">&quot;v2&quot;</span><span class="p">]</span>  </div>
  
<div class="viewcode-block" id="ScalarField"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.ScalarField">[docs]</a><span class="k">class</span> <span class="nc">ScalarField</span><span class="p">(</span><span class="n">MetaField</span><span class="p">):</span>
  <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span>  </div>
    
<span class="c1">################################################################################</span>
    

<span class="c1">################################################################################</span>
<span class="c1"># PARSERS</span>
<span class="c1">################################################################################</span>
<span class="k">def</span> <span class="nf">read_h5</span><span class="p">(</span><span class="n">hdfstore</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  DEPRECATED</span>
<span class="sd">  Reads a mesh saved in the HDF5 format.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">()</span>
  <span class="n">m</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;elements/connectivity&quot;</span><span class="p">]</span>
  <span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;nodes/xyz&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hdf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/nodes/sets&quot;</span><span class="p">):</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/nodes/sets/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/elements/sets&quot;</span><span class="p">):</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/elements/sets/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">sets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/elements/surfaces&quot;</span><span class="p">):</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/elements/surfaces/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">m</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/fields/&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/metadata&quot;</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;fields/</span><span class="si">{0}</span><span class="s2">/metadata&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;fields/</span><span class="si">{0}</span><span class="s2">/data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">m</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
  <span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  
  <span class="k">return</span> <span class="n">m</span>
  

<div class="viewcode-block" id="read_msh"><a class="viewcode-back" href="../../mesh.html#argiope.mesh.read_msh">[docs]</a><span class="k">def</span> <span class="nf">read_msh</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Reads a GMSH MSH file and returns a :class:`Mesh` instance. </span>
<span class="sd">  </span>
<span class="sd">  :arg path: path to MSH file.</span>
<span class="sd">  :type path: str</span>
<span class="sd">  </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">elementMap</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">15</span><span class="p">:</span><span class="s2">&quot;point1&quot;</span><span class="p">,</span>
                 <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;line2&quot;</span><span class="p">,</span>
                 <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;tri3&quot;</span><span class="p">,</span>
                 <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;quad4&quot;</span><span class="p">,</span>
                 <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;tetra4&quot;</span><span class="p">,</span>
                 <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;hexa8&quot;</span><span class="p">,</span>
                 <span class="mi">6</span><span class="p">:</span><span class="s2">&quot;prism6&quot;</span><span class="p">,</span>
                 <span class="mi">7</span><span class="p">:</span><span class="s2">&quot;pyra4&quot;</span><span class="p">,</span>
                 
               <span class="p">}</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
  <span class="n">locs</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">nl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nl</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$end&quot;</span><span class="p">):</span>
        <span class="n">locs</span><span class="p">[</span><span class="n">env</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> 
        <span class="n">locs</span><span class="p">[</span><span class="n">env</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="n">nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
          <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                   <span class="n">lines</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;nodes&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]])),</span> 
                   <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
                   <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">])</span>
  
  <span class="n">elements</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;labels&quot;</span><span class="p">:[],</span> <span class="s2">&quot;etype&quot;</span><span class="p">:[],</span> <span class="s2">&quot;conn&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;tags&quot;</span><span class="p">:[],</span> <span class="s2">&quot;sets&quot;</span><span class="p">:{}}</span>
  
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;elements&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
    <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;etype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elementMap</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="p">)</span>
    <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span> <span class="mi">3</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="p">)</span> 
    <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;conn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]:])</span>
  <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">])</span>
  <span class="n">physicalNames</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;physicalnames&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">locs</span><span class="p">[</span><span class="s2">&quot;physicalnames&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]:</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">physicalNames</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  <span class="n">sets</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">]])</span>
  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">physicalNames</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">sets</span><span class="p">[</span><span class="n">physicalNames</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span> <span class="o">==</span> <span class="n">k</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">])</span>     
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  for tag, values in sets.items():</span>
<span class="sd">    elements[&quot;sets&quot;][tag] = elements[&quot;labels&quot;][values]     </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sets</span>
  <span class="k">return</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">nlabels</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">],</span> 
              <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nodes</span><span class="p">[[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">]]),</span>
              <span class="n">elabels</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">],</span>
              <span class="n">conn</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;conn&quot;</span><span class="p">],</span>
              <span class="n">types</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;etype&quot;</span><span class="p">],</span>
              <span class="n">esets</span> <span class="o">=</span> <span class="n">elements</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">])</span></div>

<span class="k">def</span> <span class="nf">read_inp</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Reads Abaqus inp file</span>
<span class="sd">  &quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="nf">lineInfo</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span> 
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;comment&quot;</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;command&quot;</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
          <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span>  <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)]</span>
          <span class="n">out</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">out</span>
  
  <span class="k">def</span> <span class="nf">elementMapper</span><span class="p">(</span><span class="n">inpeltype</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">inpeltype</span> <span class="o">==</span> <span class="s2">&quot;t3d2&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;Line2&quot;</span>
    <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cps&quot;</span><span class="p">,</span> <span class="s2">&quot;cpe&quot;</span><span class="p">,</span> <span class="s2">&quot;cax&quot;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;tri3&quot;</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;quad4&quot;</span>
    <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;c3d&quot;</span><span class="p">]:</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;tetra4&quot;</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;pyra5&quot;</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;6&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;prism6&quot;</span>
      <span class="k">if</span> <span class="n">inpeltype</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;8&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;hexa8&quot;</span>
    
  <span class="n">nlabels</span>      <span class="o">=</span> <span class="p">[]</span>
  <span class="n">coords</span>       <span class="o">=</span> <span class="p">[]</span>
  <span class="n">nsets</span>        <span class="o">=</span> <span class="p">{}</span>
  <span class="n">elabels</span>      <span class="o">=</span> <span class="p">[]</span>
  <span class="n">etypes</span>       <span class="o">=</span> <span class="p">[]</span>
  <span class="n">connectivity</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">esets</span>        <span class="o">=</span> <span class="p">{}</span>
  <span class="n">surfaces</span>     <span class="o">=</span> <span class="p">{}</span>
  
  <span class="c1"># File preprocessing</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()])</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span>  <span class="n">lines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
  <span class="c1"># Data processing</span>
  <span class="n">env</span><span class="p">,</span> <span class="n">setlabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span> 
    <span class="n">d</span> <span class="o">=</span> <span class="n">lineInfo</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> 
      <span class="n">env</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
      <span class="c1"># Nodes</span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
        <span class="n">currentset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;nset&quot;</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
          <span class="n">currentset</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nset&quot;</span><span class="p">]</span>
          <span class="n">nsets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
           
      <span class="c1"># Elements</span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
        <span class="n">eltype</span> <span class="o">=</span> <span class="n">elementMapper</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
        <span class="n">currentset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;elset&quot;</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
          <span class="n">currentset</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;elset&quot;</span><span class="p">]</span>
          <span class="n">esets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
          
      <span class="c1"># Nsets</span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;nset&quot;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>      
        <span class="n">currentset</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;nset&quot;</span><span class="p">]</span>
        <span class="n">nsets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
      <span class="c1"># Elsets     </span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;elset&quot;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>      
        <span class="n">currentset</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;elset&quot;</span><span class="p">]</span>
        <span class="n">esets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      
      <span class="c1"># Surfaces</span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
        <span class="n">currentsurface</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span>
          <span class="n">surfaces</span><span class="p">[</span><span class="n">currentsurface</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  
                    
             
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> 
      <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
        <span class="n">nlabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> 
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]])</span>
                     <span class="p">)</span>
        <span class="k">if</span> <span class="n">currentset</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nsets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            
              
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span> 
        <span class="n">label</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">elabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">connectivity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">])</span>
                           <span class="p">)</span>
        <span class="n">etypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eltype</span><span class="p">)</span>                   
        <span class="k">if</span> <span class="n">currentset</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">esets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;nset&quot;</span><span class="p">:</span>
        <span class="n">nsets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>   
        
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;elset&quot;</span><span class="p">:</span>
        <span class="n">esets</span><span class="p">[</span><span class="n">currentset</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>  
      
      <span class="k">if</span> <span class="n">env</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;element&quot;</span><span class="p">:</span>
          <span class="n">surfaces</span><span class="p">[</span><span class="n">currentsurface</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span><span class="p">])</span>
  
  <span class="n">surfaces2</span> <span class="o">=</span> <span class="p">{}</span>        
  <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">surface</span> <span class="ow">in</span> <span class="n">surfaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">surfaces2</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sdata</span> <span class="ow">in</span> <span class="n">surface</span><span class="p">:</span>
      <span class="n">labels</span> <span class="o">=</span> <span class="n">esets</span><span class="p">[</span><span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
      <span class="n">face</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">surfaces2</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">face</span><span class="p">))</span>             
  
  <span class="k">return</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">nlabels</span> <span class="o">=</span> <span class="n">nlabels</span><span class="p">,</span>
              <span class="n">coords</span>  <span class="o">=</span> <span class="n">coords</span><span class="p">,</span>
              <span class="n">nsets</span>   <span class="o">=</span> <span class="n">nsets</span><span class="p">,</span>
              <span class="n">elabels</span> <span class="o">=</span> <span class="n">elabels</span><span class="p">,</span>
              <span class="n">etypes</span>  <span class="o">=</span> <span class="n">etypes</span><span class="p">,</span>
              <span class="n">connectivity</span> <span class="o">=</span> <span class="n">connectivity</span><span class="p">,</span>
              <span class="n">esets</span> <span class="o">=</span> <span class="n">esets</span><span class="p">,)</span>
              <span class="c1">#surfaces = surfaces2)</span>
  
<span class="c1">################################################################################</span>
<span class="c1"># WRITERS</span>
<span class="c1">################################################################################</span>

<span class="k">def</span> <span class="nf">write_xdmf</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dataformat</span> <span class="o">=</span> <span class="s2">&quot;XML&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Dumps the mesh to XDMF format.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">MODPATH</span> <span class="o">+</span> <span class="s2">&quot;/templates/mesh/xdmf.xdmf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="n">attribute_pattern</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">MODPATH</span> <span class="o">+</span> <span class="s2">&quot;/templates/mesh/xdmf_attribute.xdmf&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="c1"># MAPPINGS</span>
  <span class="n">cell_map</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;tri3&quot;</span><span class="p">:</span>   <span class="mi">4</span><span class="p">,</span>
      <span class="s2">&quot;quad4&quot;</span><span class="p">:</span>  <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;tetra4&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
      <span class="s2">&quot;pyra5&quot;</span><span class="p">:</span>  <span class="mi">7</span><span class="p">,</span>
      <span class="s2">&quot;prism6&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
      <span class="s2">&quot;hexa8&quot;</span><span class="p">:</span>  <span class="mi">9</span><span class="p">}</span>
  <span class="c1"># REFERENCES</span>
  <span class="n">nodes</span><span class="p">,</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">data</span>
  <span class="n">fields</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">fields</span>
  <span class="c1"># NUMBERS</span>
  <span class="n">Ne</span><span class="p">,</span> <span class="n">Nn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
  <span class="c1"># NODES</span>
  <span class="n">nodes_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">nodes_map</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
  <span class="n">nodes_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="c1"># ELEMENTS</span>
  <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
  <span class="n">connectivities</span>  <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
  <span class="n">connectivities</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">connectivities</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">connectivities</span> <span class="o">=</span> <span class="n">connectivities</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
  <span class="n">connectivities</span> <span class="o">=</span> <span class="n">nodes_map</span><span class="p">[</span><span class="n">connectivities</span><span class="p">]</span>
  <span class="n">labels</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
  <span class="n">etypes</span>          <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell_map</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">elements</span><span class="o">.</span><span class="n">etype</span><span class="p">])</span>
  <span class="n">lconn</span>           <span class="o">=</span> <span class="n">Ne</span> <span class="o">+</span> <span class="p">(</span><span class="n">connectivities</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  <span class="c1"># FIELDS</span>
  <span class="n">fields_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="n">field_data</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
      <span class="n">fshape</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span>   <span class="n">fshape</span>  <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;Scalar&quot;</span>
      <span class="k">elif</span> <span class="n">fshape</span>  <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
      <span class="k">elif</span> <span class="n">fshape</span>  <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
        <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;Vector&quot;</span>
        <span class="c1"># UGLY HACK...</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;v3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="c1"># BACK TO NORMAL  </span>
      <span class="k">elif</span> <span class="n">fshape</span>  <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;Tensor6&quot;</span>
      <span class="k">elif</span> <span class="n">fshape</span>  <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> 
        <span class="n">ftype</span> <span class="o">=</span> <span class="s2">&quot;Tensor6&quot;</span>
        <span class="c1"># UGLY HACK...</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;v13&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;v23&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
        <span class="c1"># BACK TO NORMAL  </span>
      <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;Nodal&quot;</span><span class="p">:</span> 
        <span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;Node&quot;</span>
      <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s2">&quot;Element&quot;</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;Cell&quot;</span>  
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;TAG&quot;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">tag</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;ATTRIBUTETYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftype</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;FORMAT&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">dataformat</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;FIELD_DIMENSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;POSITION&quot;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">position</span>                             
  <span class="k">if</span> <span class="n">dataformat</span> <span class="o">==</span> <span class="s2">&quot;XML&quot;</span><span class="p">:</span>
    <span class="c1">#NODES</span>
    <span class="n">nodes_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="mi">11</span><span class="o">*</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">n</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
                              <span class="n">n</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> 
                              <span class="n">n</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()])</span>
    <span class="c1"># ELEMENTS</span>
    <span class="n">elements_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ne</span><span class="p">):</span>
      <span class="n">elements_string</span> <span class="o">+=</span> <span class="mi">11</span><span class="o">*</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etypes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">connectivities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
      <span class="n">elements_string</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">elements_strings</span> <span class="o">=</span> <span class="n">elements_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
    <span class="c1"># FIELDS</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">fdata</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> 
                                <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                <span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">fdata</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span> <span class="o">*</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">fdata</span><span class="p">]</span>
      <span class="n">fdata</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fdata</span><span class="p">)</span>
      <span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">][</span><span class="s2">&quot;DATA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fdata</span>
      <span class="n">fields_string</span> <span class="o">+=</span> <span class="n">attribute_pattern</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="n">field_data</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>     
  <span class="k">elif</span> <span class="n">dataformat</span> <span class="o">==</span> <span class="s2">&quot;HDF&quot;</span><span class="p">:</span>
    <span class="n">hdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>
    <span class="n">hdf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;COORDS&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="s2">&quot;xyz&quot;</span><span class="p">)])</span>
    <span class="n">flatconn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lconn</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ne</span><span class="p">):</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">connectivities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
      <span class="n">lc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
      <span class="n">flatconn</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">etypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">flatconn</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lc</span><span class="p">)]</span> <span class="o">=</span> <span class="n">c</span>
      <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">lc</span>
    <span class="n">hdf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;CONNECTIVITY&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">flatconn</span><span class="p">))</span>  
    <span class="n">nodes_string</span> <span class="o">=</span> <span class="mi">11</span><span class="o">*</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.h5:/COORDS/block0_values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">elements_string</span> <span class="o">=</span> <span class="mi">11</span><span class="o">*</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.h5:/CONNECTIVITY/block0_values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">fstrings</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">fstrings</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#DATA&quot;</span><span class="p">,</span> 
         <span class="mi">11</span><span class="o">*</span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.h5:/FIELDS/</span><span class="si">{1}</span><span class="s2">/block0_values&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
      <span class="n">fields_string</span> <span class="o">+=</span> <span class="n">fstrings</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>         
      <span class="n">hdf</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;FIELDS/</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="n">fields</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  pattern = pattern.replace(&quot;#ELEMENT_NUMBER&quot;, str(Ne))</span>
<span class="sd">  pattern = pattern.replace(&quot;#CONN_DIMENSION&quot;, str(lconn))</span>
<span class="sd">  pattern = pattern.replace(&quot;#CONN_PATH&quot;, elements_string)</span>
<span class="sd">  pattern = pattern.replace(&quot;#NODE_NUMBER&quot;, str(Nn))</span>
<span class="sd">  pattern = pattern.replace(&quot;#NODE_PATH&quot;, nodes_string)</span>
<span class="sd">  pattern = pattern.replace(&quot;#DATAFORMAT&quot;, dataformat)</span>
<span class="sd">  pattern = pattern.replace(&quot;#ATTRIBUTES&quot;, fields_string) </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">fields_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attribute_pattern</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="o">**</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field_data</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
     <span class="n">ELEMENT_NUMBER</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Ne</span><span class="p">),</span>
     <span class="n">CONN_DIMENSION</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lconn</span><span class="p">),</span>
     <span class="n">CONN_PATH</span>      <span class="o">=</span> <span class="n">elements_string</span><span class="p">,</span>
     <span class="n">NODE_NUMBER</span>    <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Nn</span><span class="p">),</span>
     <span class="n">NODE_PATH</span>      <span class="o">=</span> <span class="n">nodes_string</span><span class="p">,</span>
     <span class="n">DATAFORMAT</span>     <span class="o">=</span> <span class="n">dataformat</span><span class="p">,</span>
     <span class="n">ATTRIBUTES</span>     <span class="o">=</span> <span class="n">fields_string</span><span class="p">)</span>
  <span class="nb">open</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;.xdmf&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_inp</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxwidth</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">sections</span> <span class="o">=</span> <span class="s2">&quot;solid&quot;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Exports the mesh to the INP format.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">set_to_inp</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">sk</span> <span class="ow">in</span> <span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">labels</span> <span class="o">=</span> <span class="n">sets</span><span class="p">[</span><span class="n">sk</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sets</span><span class="p">[</span><span class="n">sk</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
      <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
      <span class="n">labels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ss</span> <span class="o">+=</span> <span class="s2">&quot;*</span><span class="si">{0}</span><span class="s2">, </span><span class="si">{0}</span><span class="s2">=</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">sk</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
          <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">maxwidth</span><span class="p">)</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">maxwidth</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="n">s</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">ss</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">s</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ss</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>            

  <span class="c1"># DATA</span>
  <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="c1"># NODES</span>
  <span class="n">nodes_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
  <span class="n">nodes_output</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">nodes_output</span><span class="p">]))</span>
  
  <span class="c1"># NODE SETS</span>
  <span class="k">if</span> <span class="s2">&quot;sets&quot;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
    <span class="n">nsets</span> <span class="o">=</span> <span class="n">set_to_inp</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">sets</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="s2">&quot;NSET&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">nsets</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
  
  <span class="c1"># SURFACES </span>
  <span class="n">surf_output</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">if</span> <span class="s2">&quot;surfaces&quot;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">surfaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sindex</span> <span class="ow">in</span>  <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sk</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="n">slabel</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">sindex</span><span class="p">]</span>
      <span class="n">surface</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">surfaces</span><span class="p">[</span><span class="n">slabel</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">surface</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">surface_to_element_sets</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span>
        <span class="n">surf_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;*SURFACE, TYPE=ELEMENT, NAME=</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slabel</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">findex</span> <span class="ow">in</span> <span class="n">surface</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
          <span class="k">if</span> <span class="n">surface</span><span class="p">[</span><span class="n">findex</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">surf_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  _SURF_</span><span class="si">{0}</span><span class="s2">_FACE</span><span class="si">{1}</span><span class="s2">, S</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slabel</span><span class="p">,</span> 
                                                                  <span class="n">findex</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> 
  <span class="k">else</span><span class="p">:</span>
    <span class="n">surf_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;**&quot;</span><span class="p">)</span>
  
  <span class="c1"># ELEMENTS</span>
  <span class="n">elements_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">for</span> <span class="n">etype</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(((</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;solver&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),)):</span>
    <span class="n">els</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">header</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                                               <span class="n">float_format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">elements_output</span> <span class="o">+=</span> <span class="s2">&quot;*ELEMENT, TYPE=</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">etype</span><span class="p">)</span>
    <span class="n">elements_output</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;  &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span>
                             <span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">els</span><span class="p">]))</span>
    <span class="n">elements_output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="n">elements_output</span> <span class="o">=</span> <span class="n">elements_output</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
  <span class="n">el_sets</span> <span class="o">=</span> <span class="p">{}</span> 

  <span class="c1"># MATERIALS</span>
  <span class="n">section_output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">for</span> <span class="n">material</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;materials&quot;</span><span class="p">):</span>
    <span class="n">slabel</span> <span class="o">=</span> <span class="s2">&quot;_MAT_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">material</span><span class="p">)</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="p">[(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">slabel</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;sets&quot;</span><span class="p">,</span> <span class="n">slabel</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">sections</span> <span class="o">==</span> <span class="s2">&quot;solid&quot;</span><span class="p">:</span>
      <span class="n">section_output</span> <span class="o">+=</span> <span class="s2">&quot;*SOLID SECTION, ELSET=_MAT_</span><span class="si">{0}</span><span class="s2">, MATERIAL=</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
       <span class="n">material</span><span class="p">)</span>

  <span class="c1"># ELEMENTS SETS</span>
  <span class="k">if</span> <span class="s2">&quot;sets&quot;</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> 
    <span class="n">esets</span> <span class="o">=</span> <span class="n">set_to_inp</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">sets</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;&quot;</span><span class="p">],</span><span class="s2">&quot;ELSET&quot;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">esets</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  ek = mesh.elements.sets.keys()</span>
<span class="sd">  for esindex in  np.unique(ek.labels[0]):</span>
<span class="sd">    eslabel = ek.levels[0][esindex]</span>
<span class="sd">    eset = mesh.elements.sets[slabel]</span>
<span class="sd">  &quot;&quot;&quot;</span>
     
  <span class="c1"># PATTERN</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">MODPATH</span> <span class="o">+</span> <span class="s2">&quot;/templates/mesh/inp.inp&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
    <span class="n">NODES</span>     <span class="o">=</span> <span class="n">nodes_output</span><span class="p">,</span>
    <span class="n">NODE_SETS</span> <span class="o">=</span> <span class="n">nsets</span><span class="p">,</span>
    <span class="n">ELEMENTS</span>  <span class="o">=</span> <span class="n">elements_output</span><span class="p">,</span>
    <span class="n">ELEMENT_SETS</span> <span class="o">=</span> <span class="n">esets</span><span class="p">,</span>
    <span class="n">ELEMENT_SURFACES</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">surf_output</span><span class="p">),</span>
    <span class="n">SECTIONS</span> <span class="o">=</span> <span class="n">section_output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>            
    <span class="k">return</span> <span class="n">pattern</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
  

<span class="c1">################################################################################</span>
<span class="c1"># TESTS</span>
<span class="c1">################################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">if __name__ == &#39;__main__&#39;:</span>
<span class="sd">  import time</span>
<span class="sd">  print(&quot;# READING MESH&quot;)</span>
<span class="sd">  t0 = time.time()</span>
<span class="sd">  m2 = read_msh(&quot;../doc/mesh/demo.msh&quot;)</span>
<span class="sd">  t1 =  time.time()</span>
<span class="sd">  print &quot;# =&gt; {0:.2f}s&quot;.format(t1-t0)</span>
<span class="sd">  </span>
<span class="sd">  print &quot;# EXPORTING MESH&quot;</span>
<span class="sd">  write_xdmf(m2, &quot;test&quot;, dataformat = &quot;HDF&quot;)</span>
<span class="sd">     </span>
<span class="sd">  t2 =  time.time()</span>
<span class="sd">  </span>

<span class="sd">  print &quot;# =&gt; {0:.2f}s&quot;.format(t2-t1)  </span>
<span class="sd">  </span>
<span class="sd">&quot;&quot;&quot;</span>    
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>